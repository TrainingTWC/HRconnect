<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THIRD WAVE COFFEE | HR CONNECT</title>
  <meta name="description" content="HR Connect Pulse Survey" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f3f4f6 }
    .card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 6px 20px rgba(15,23,42,0.06) }
    .qtitle { font-weight: 700; color:#0f172a }
    /* Page header: tighter spacing and consistent sizing */
    .page-header { display: flex; align-items: center; gap: 2px; padding-bottom: 6px; }
    .page-header .left { font-weight: 900; font-size: 42px; line-height: 1; color: #071428; text-transform: uppercase; letter-spacing: 0.5px; }
    .page-header .right { font-weight: 900; font-size: 42px; line-height: 1; color: #071428; }
    /* Responsive adjustments */
    @media (max-width: 639px) {
      .page-header { gap: 2px; }
      .page-header .left { font-size: 24px; }
      .page-header .right { font-size: 24px; }
    }
    @media (min-width: 640px) {
      .page-header .left { font-size: 28px; }
      .page-header .right { font-size: 28px; }
    }
  </style>
</head>
<body class="p-6">
  <div id="root" class="max-w-3xl mx-auto"></div>

  <script type="text/babel">
    const { useState } = React;

    const QUESTIONS = [
      { id: 'q1', title: 'Is there any work pressure in the cafÃ©?', type: 'radio', choices: [
        {label: 'Excellent', score: 5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q2', title: 'Are you empowered to make decisions on the spot to help customers and immediately solve their problems/complaints?', type: 'radio', choices: [
        {label: 'Every time', score:5}, {label: 'Most of the time', score:4}, {label: 'Sometime', score:3}, {label: 'At Time', score:2}, {label: 'Never', score:1}
      ]},
      { id: 'q3', title: 'Do you receive regular performance reviews and constructive feedback from your SM / AM ?', type: 'radio', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q4', title: 'Do you think there is any partiality or unfair treatment within team ?', type: 'radio', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q5', title: 'Are you getting the training as per Wings program? What was the last training you got and when ?', type: 'radio', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q6', title: 'Are you facing any issues with operational Apps ( Zing, Meal benefit, Jify ) or any issues with PF, ESI, Reimbursements,Insurance & Payslips', type: 'radio', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q7', title: 'Have you gone through the HR Handbook on Zing / Accepted all the policies?', type: 'radio', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q8', title: 'Are you satisfied with your current work schedule - Working Hours, Breaks, Timings, Weekly Offs & Comp Offs ?', type: 'radio', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q9', title: 'How effectively does the team collaborate, and what factors contribute to that?', type: 'radio', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ]},
      { id: 'q10', title: 'Name one of your colleague who is very helpful on the floor', type: 'input' },
      { id: 'q11', title: 'Any suggestions or support required from the organization ?', type: 'textarea' },
      { id: 'q12', title: 'On a scale of 1 to 5 how do you rate your experience with TWC & why ?', type: 'scale', choices: [
        {label: 'Excellent', score:5}, {label: 'Very Good', score:4}, {label: 'Good', score:3}, {label: 'Average', score:2}, {label: 'Poor', score:1}
      ] }
    ];

    // Remote logging endpoint (Apps Script URL provided by user)
    const LOG_ENDPOINT = 'https://script.google.com/macros/s/AKfycby2Q2O8ErAzt7W8WY41O0Kz-LH78FxSSzDAJ8h9w397q-Yb7r6oFCxgb_-RycBc_qnCeA/exec';

    function HRConnectForm(){
      // Get HR details from URL parameters
      const getUrlParams = () => {
        const params = new URLSearchParams(window.location.search);
        return {
          hrName: params.get('name') || '',  // Changed from hrName to name
          hrId: params.get('id') || ''       // Changed from hrId to id
        };
      };

      // Restore saved responses and meta from localStorage so form survives refresh
      const [resp, setResp] = useState(() => {
        try { return JSON.parse(localStorage.getItem('hr_resp') || '{}'); } catch (e) { return {}; }
      });
      const [submitted, setSubmitted] = useState(false);

      // Metadata fields for header - initialize with URL params
      const [meta, setMeta] = useState(() => {
        const urlParams = getUrlParams();
        try { 
          const stored = JSON.parse(localStorage.getItem('hr_meta') || '{}');
          return Object.assign(
            {hrName:'',hrId:'',empName:'',empId:'',storeName:'',storeId:''}, 
            stored,
            // URL params override stored values
            {
              hrName: urlParams.hrName || stored.hrName || '',
              hrId: urlParams.hrId || stored.hrId || ''
            }
          ); 
        } catch (e) { 
          return {
            hrName: urlParams.hrName || '',
            hrId: urlParams.hrId || '',
            empName:'',
            empId:'',
            storeName:'',
            storeId:''
          }; 
        }
      });
      const handleMetaChange = (key, value) => {
        setMeta(prev => {
          const next = {...prev, [key]: value};
          try { localStorage.setItem('hr_meta', JSON.stringify(next)); } catch(e){}
          return next;
        });
      };

      const handleChange = (id, value) => {
        setResp(prev => {
          const next = {...prev, [id]: value};
          try { localStorage.setItem('hr_resp', JSON.stringify(next)); } catch(e){}
          return next;
        });
      };

      // Ensure any external changes also persist (edge case)
      React.useEffect(()=>{
        try{ localStorage.setItem('hr_resp', JSON.stringify(resp)); }catch(e){}
      },[resp]);
      React.useEffect(()=>{
        try{ localStorage.setItem('hr_meta', JSON.stringify(meta)); }catch(e){}
      },[meta]);

      const validate = () => {
        // require answer for radio/scale questions
        for(const q of QUESTIONS){
          if((q.type === 'radio' || q.type === 'scale') && (resp[q.id] == null || resp[q.id] === '')) return {ok:false, missing:q.id};
        }
        return {ok:true};
      };

      const computeScore = () => {
        let total = 0, max = 0;
        for(const q of QUESTIONS){
          if(q.choices){
            const choice = q.choices.find(c=>c.label === resp[q.id]);
            if(choice){ total += choice.score; max += Math.max(...q.choices.map(c=>c.score)); }
          }
        }
        return { total, max, percent: max? Math.round((total/max)*100):0 };
      };

      const onSubmit = async (e) =>{
        e.preventDefault();
        const ok = validate();
        if(!ok.ok){
          const el = document.querySelector(`[name="${ok.missing}"]`);
          if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
          alert('Please answer all required questions.');
          return;
        }

        // Vibrate if supported
        if ('vibrate' in navigator) {
          navigator.vibrate(200); // vibrate for 200ms
        }

        // Generate and download PDF first
        await generatePdf();
        
        // Show success message
        alert('Survey submitted and report downloaded successfully!');
        
        setSubmitted(true);

        // Log form data to remote endpoint
        const logData = async () => {
          const score = computeScore();
          // Build flat params expected by the Apps Script doPost
          const params = {
            submissionTime: new Date().toLocaleString('en-GB',{hour12:false}),
            hrName: meta.hrName || '',
            hrId: meta.hrId || '',
            empName: meta.empName || '',
            empId: meta.empId || '',
            storeName: meta.storeName || '',
            storeID: meta.storeId || '',
            q1: resp['q1'] || '',
            q2: resp['q2'] || '',
            q3: resp['q3'] || '',
            q4: resp['q4'] || '',
            q5: resp['q5'] || '',
            q6: resp['q6'] || '',
            q7: resp['q7'] || '',
            q8: resp['q8'] || '',
            q9: resp['q9'] || '',
            q10: resp['q10'] || '',
            q11: resp['q11'] || '',
            q12: resp['q12'] || '',
            totalScore: score.total || '',
            maxScore: score.max || '',
            percent: score.percent || ''
          };
          // form-encode
          const body = Object.keys(params).map(k=> encodeURIComponent(k)+'='+encodeURIComponent(params[k])).join('&');
          try {
            await fetch(LOG_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
              body
            });
            console.log('Data logged successfully:', params);
          } catch (error) {
            console.error('Error logging data:', error);
          }
        };
        logData();
      };

      const score = computeScore();

      // PDF generation
      const generatePdf = async () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4' });
        let y = 12;

  // Header (single-line title)
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(16);
  doc.setTextColor('#000000');
  doc.text('THIRD WAVE COFFEE | HR CONNECT', 14, y);
  doc.setFontSize(11);
  doc.setFont('helvetica','normal');
  y += 7;

        // Metadata block (black text)
        doc.setFontSize(10);
        doc.setFont('helvetica','bold');
        doc.text('Survey Details', 14, y);
        doc.setFont('helvetica','normal');
        y += 6;
        doc.text(`HR Name: ${meta.hrName || '-'}`, 14, y);
        doc.text(`HR ID: ${meta.hrId || '-'}`, 110, y);
        y += 6;
        doc.text(`Emp Name: ${meta.empName || '-'}`, 14, y);
        doc.text(`Emp ID: ${meta.empId || '-'}`, 110, y);
        y += 6;
        doc.text(`Store Name: ${meta.storeName || '-'}`, 14, y);
        doc.text(`Store ID: ${meta.storeId || '-'}`, 110, y);
        y += 10;

        // Score summary (bold, black)
        doc.setFont('helvetica','bold');
        doc.setFontSize(12);
        doc.text(`Score: ${score.total} / ${score.max}   (${score.percent}%)`, 14, y);
        y += 6;

        // Infographic: horizontal gradient bar showing percent (red -> yellow -> green)
        const barX = 14, barY = y, barW = 180, barH = 9;
        // Draw a subtle border
        doc.setDrawColor(0);
        doc.setLineWidth(0.3);
        doc.rect(barX - 0.5, barY - 0.5, barW + 1, barH + 1);

        // Helper: linear interpolate color channels
        function lerp(a, b, t){ return Math.round(a + (b - a) * t); }
        function colorAt(t){
          // t in [0,1]
          if (t <= 0.5) {
            // red (255,0,0) -> yellow (255,204,0)
            const tt = t / 0.5;
            const r = lerp(255, 255, tt);
            const g = lerp(0, 204, tt);
            const b = lerp(0, 0, tt);
            return [r,g,b];
          } else {
            // yellow (255,204,0) -> green (34,177,76)
            const tt = (t - 0.5) / 0.5;
            const r = lerp(255, 34, tt);
            const g = lerp(204, 177, tt);
            const b = lerp(0, 76, tt);
            return [r,g,b];
          }
        }

        // Draw gradient by thin vertical slices
        const sliceW = 1; // 1 mm slices
        for(let i = 0; i < barW; i += sliceW){
          const t = i / (barW - 1);
          const [r,g,b] = colorAt(t);
          doc.setFillColor(r, g, b);
          doc.rect(barX + i, barY, sliceW, barH, 'F');
        }

        // Mask unfilled portion with white rectangle so only filled portion shows the gradient
        const fillW = Math.max(0, Math.min(barW, Math.round((score.percent/100) * barW)));
        if (fillW < barW){
          doc.setFillColor(255,255,255);
          doc.rect(barX + fillW, barY, barW - fillW, barH, 'F');
        }

        // Percent label (black)
        doc.setFont('helvetica','bold');
        doc.setFontSize(10);
        doc.setTextColor('#000000');
        doc.text(`${score.percent}%`, barX + barW + 6, barY + barH - 1);

        y += barH + 12;

        // Two-column Q/A table using autoTable with black text
        const rows = QUESTIONS.map(q => [q.title, String(resp[q.id] || '-')]);
        doc.autoTable({
          startY: y,
          head: [['Question', 'Answer']],
          body: rows,
          styles: { fontSize: 10, textColor: '#000000' },
          headStyles: { fillColor: [255,255,255], textColor: '#000000', fontStyle: 'bold' },
          columnStyles: { 0: { cellWidth: 110 }, 1: { cellWidth: 60 } },
          margin: { left: 14, right: 14 }
        });

        // Footer / timestamp
        const finalY = doc.lastAutoTable ? (doc.lastAutoTable.finalY + 8) : (y + 8);
        doc.setFontSize(9);
        doc.setFont('helvetica','normal');
        doc.text(`Generated: ${new Date().toLocaleString()}`, 14, finalY);

        doc.save(`HRPulse_${(meta.empName||'employee').replace(/\s+/g,'_')}_${Date.now()}.pdf`);
      };

      return (
        <div>
          <div className="page-header mb-2">
            <span className="left">THIRD WAVE COFFEE</span>
            <span className="right">| HR CONNECT</span>
          </div>
          <form onSubmit={onSubmit} className="space-y-4">
            {/* Header / metadata card */}
            <div className="card">
              <div className="qtitle mb-3">Survey Details</div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label className="flex flex-col text-sm">
                  <span className="mb-1">HR Name</span>
                  <input className="p-2 border rounded" value={meta.hrName} onChange={e=>handleMetaChange('hrName', e.target.value)} />
                </label>
                <label className="flex flex-col text-sm">
                  <span className="mb-1">HR ID</span>
                  <input className="p-2 border rounded" value={meta.hrId} onChange={e=>handleMetaChange('hrId', e.target.value)} />
                </label>
                <label className="flex flex-col text-sm">
                  <span className="mb-1">Emp. Name</span>
                  <input className="p-2 border rounded" value={meta.empName} onChange={e=>handleMetaChange('empName', e.target.value)} />
                </label>
                <label className="flex flex-col text-sm">
                  <span className="mb-1">Emp. ID</span>
                  <input className="p-2 border rounded" value={meta.empId} onChange={e=>handleMetaChange('empId', e.target.value)} />
                </label>
                <label className="flex flex-col text-sm">
                  <span className="mb-1">Store Name</span>
                  <input className="p-2 border rounded" value={meta.storeName} onChange={e=>handleMetaChange('storeName', e.target.value)} />
                </label>
                <label className="flex flex-col text-sm">
                  <span className="mb-1">Store ID</span>
                  <input className="p-2 border rounded" value={meta.storeId} onChange={e=>handleMetaChange('storeId', e.target.value)} />
                </label>
              </div>
            </div>

            {QUESTIONS.map(q=> (
              <div key={q.id} className="card">
                <div className="qtitle mb-2">{q.title}</div>
                {q.type === 'radio' && (
                  <div className="flex flex-col gap-2">
                    {q.choices.map((c,idx)=> (
                      <label key={idx} className="inline-flex items-center space-x-2">
                        <input
                          type="radio"
                          name={q.id}
                          value={c.label}
                          checked={resp[q.id] === c.label}
                          onChange={e=>handleChange(q.id, e.target.value)}
                        />
                        <span>{c.label}</span>
                      </label>
                    ))}
                  </div>
                )}
                {q.type === 'scale' && (
                  <div className="flex gap-4">
                    {q.choices.map((c,idx)=> (
                      <label key={idx} className="flex flex-col items-center">
                        <input
                          type="radio"
                          name={q.id}
                          value={c.label}
                          checked={resp[q.id] === c.label}
                          onChange={e=>handleChange(q.id, e.target.value)}
                        />
                        <span className="text-sm text-gray-600">{c.label}</span>
                      </label>
                    ))}
                  </div>
                )}
                {q.type === 'input' && (
                  <input className="w-full mt-2 p-2 border rounded" type="text" value={resp[q.id]||''} onChange={e=>handleChange(q.id,e.target.value)} />
                )}
                {q.type === 'textarea' && (
                  <textarea className="w-full mt-2 p-2 border rounded" rows="4" value={resp[q.id]||''} onChange={e=>handleChange(q.id,e.target.value)} />
                )}
              </div>
            ))}

            <div className="flex items-center justify-between">
              <div className="text-sm text-gray-600">All radio/scale questions are required.</div>
              <div className="flex gap-2">
                <button type="button" className="px-4 py-2 border rounded" onClick={()=>{ localStorage.removeItem('hr_resp'); localStorage.removeItem('hr_meta'); setResp({}); setMeta({ hrName:'', hrId:'', empName:'', empId:'', storeName:'', storeId:'' }); setSubmitted(false); }}>Reset</button>
                <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">Submit</button>
              </div>
            </div>
          </form>

          {submitted && (
            <div className="mt-6 card">
              <h2 className="font-bold">Submission Summary</h2>
              <p className="mt-2">Total score: {score.total} / {score.max} ({score.percent}%)</p>
              <div className="mt-3">
                <h3 className="font-semibold">Answers</h3>
                <ul className="list-disc ml-5 mt-2 space-y-1">
                  {QUESTIONS.map(q=> (
                    <li key={q.id}><strong>{q.title}</strong>: {resp[q.id] || '-'} </li>
                  ))}
                </ul>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<HRConnectForm/>, document.getElementById('root'));
  </script>
</body>
</html>
